"use strict";(self.webpackChunkmilliwonkim_blog_site=self.webpackChunkmilliwonkim_blog_site||[]).push([[728],{3905:(e,n,t)=>{t.d(n,{Zo:()=>u,kt:()=>h});var r=t(7294);function o(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function s(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function a(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?s(Object(t),!0).forEach((function(n){o(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):s(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function c(e,n){if(null==e)return{};var t,r,o=function(e,n){if(null==e)return{};var t,r,o={},s=Object.keys(e);for(r=0;r<s.length;r++)t=s[r],n.indexOf(t)>=0||(o[t]=e[t]);return o}(e,n);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(r=0;r<s.length;r++)t=s[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(o[t]=e[t])}return o}var l=r.createContext({}),i=function(e){var n=r.useContext(l),t=n;return e&&(t="function"==typeof e?e(n):a(a({},n),e)),t},u=function(e){var n=i(e.components);return r.createElement(l.Provider,{value:n},e.children)},p="mdxType",d={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},f=r.forwardRef((function(e,n){var t=e.components,o=e.mdxType,s=e.originalType,l=e.parentName,u=c(e,["components","mdxType","originalType","parentName"]),p=i(t),f=o,h=p["".concat(l,".").concat(f)]||p[f]||d[f]||s;return t?r.createElement(h,a(a({ref:n},u),{},{components:t})):r.createElement(h,a({ref:n},u))}));function h(e,n){var t=arguments,o=n&&n.mdxType;if("string"==typeof e||o){var s=t.length,a=new Array(s);a[0]=f;var c={};for(var l in n)hasOwnProperty.call(n,l)&&(c[l]=n[l]);c.originalType=e,c[p]="string"==typeof e?e:o,a[1]=c;for(var i=2;i<s;i++)a[i]=t[i];return r.createElement.apply(null,a)}return r.createElement.apply(null,t)}f.displayName="MDXCreateElement"},4193:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>d,frontMatter:()=>s,metadata:()=>c,toc:()=>i});var r=t(7462),o=(t(7294),t(3905));const s={title:"Next.js\uc5d0 Google Drive API\ub97c \ub2ec\uc544\ubcf4\uc790"},a=void 0,c={unversionedId:"Front-End Development/nextjs/1",id:"Front-End Development/nextjs/1",title:"Next.js\uc5d0 Google Drive API\ub97c \ub2ec\uc544\ubcf4\uc790",description:"Google API\uc758 \uacbd\uc6b0, \ub300\ubd80\ubd84\uc774 \uc11c\ubc84\uc5d0\uc11c API\ub97c \ud638\ucd9c\ud574\uc57c\ud569\ub2c8\ub2e4.",source:"@site/docs/Front-End Development/nextjs/1.md",sourceDirName:"Front-End Development/nextjs",slug:"/Front-End Development/nextjs/1",permalink:"/docs/Front-End Development/nextjs/1",draft:!1,tags:[],version:"current",frontMatter:{title:"Next.js\uc5d0 Google Drive API\ub97c \ub2ec\uc544\ubcf4\uc790"},sidebar:"developmentSidebar",previous:{title:"Next.js",permalink:"/docs/category/nextjs"},next:{title:"Dockder Container \uc548\uc5d0\uc11c pm2\ub85c next.js \uc2e4\ud589\ud558\ub294 \ubc29\ubc95",permalink:"/docs/Front-End Development/nextjs/10"}},l={},i=[],u={toc:i},p="wrapper";function d(e){let{components:n,...t}=e;return(0,o.kt)(p,(0,r.Z)({},u,t,{components:n,mdxType:"MDXLayout"}),(0,o.kt)("p",null,"Google API\uc758 \uacbd\uc6b0, \ub300\ubd80\ubd84\uc774 \uc11c\ubc84\uc5d0\uc11c API\ub97c \ud638\ucd9c\ud574\uc57c\ud569\ub2c8\ub2e4."),(0,o.kt)("p",null,"\uadf8\ub807\uae30\uc5d0 React\ubcf4\ub2e4\ub294 Next.js\uc5d0\uc11c \uc11c\ubc84\uc0c1\uc5d0\uc11c \ud638\ucd9c \ud6c4, \ud504\ub860\ud2b8\uc5d0\uc11c \ud574\ub2f9 API \uc5d4\ub4dc\ud3ec\uc778\ud2b8\uc5d0\uc11c \uac12\uc744 \uc5bb\ub294 \uac83\uc774 \uac00\uc7a5 \ube60\ub974\ub2e4\uace0 \ubd05\ub2c8\ub2e4."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-tsx"},'// pages/index.tsx\n\nconst HomePage = () => {\n  const [isSuccess, setIsSuccess] = useState(false);\n  const [authUrl, setAuthUrl] = useState("");\n\n  // \ub85c\uadf8\uc778/\uc778\uc99d URL \uc5bb\uae30\n  const fetchAuthUrl = useCallback(async () => {\n    try {\n      const response = await axios.get(\n        `${process.env.API_ENDPOINT_ORIGIN}/api/auth`\n      );\n      const urlParams = new URLSearchParams(window.location.search);\n      const code = urlParams.get("code");\n      if (code) {\n        fetchTokens(code);\n        setIsSuccess(response.data.success);\n      } else if (!response.data.success) {\n        setAuthUrl(response.data.url);\n        setIsSuccess(response.data.success);\n      } else {\n        setIsSuccess(response.data.success);\n      }\n    } catch (err) {\n      console.log("err", err);\n    }\n  }, []);\n\n  const getFiles = async () => {\n    const response = await axios.get(\n      `${process.env.API_ENDPOINT_ORIGIN}/api/drive`\n    );\n    // Google Drive \ud30c\uc77c \ubaa9\ub85d\uc774 \ub098\uc634\n    console.log(response);\n  };\n\n  // Google\uc5d0\uc11c \ub9ac\ub2e4\uc774\ub809\ud2b8\ub41c \ud6c4 \uc778\uc99d \ucf54\ub4dc \uc0ac\uc6a9\ud558\uc5ec \ud1a0\ud070 \uc5bb\uae30\n  const fetchTokens = async (code: string) => {\n    try {\n      await axios.post(`${process.env.API_ENDPOINT_ORIGIN}/api/auth`, {\n        code,\n      });\n    } catch (err) {\n      console.log("fetchToken error", err);\n    }\n  };\n\n  // \ub85c\uadf8\uc544\uc6c3\n  const handleLogout = async () => {\n    const res = await axios.delete(\n      `${process.env.API_ENDPOINT_ORIGIN}/api/auth`\n    );\n    // \ub85c\uadf8\uc544\uc6c3 \ud6c4 \ud398\uc774\uc9c0 \ub9ac\ud504\ub808\uc2dc \ub610\ub294 \ub2e4\ub978 \ucc98\ub9ac\n    if (res) {\n      window.location.pathname = "";\n      window.location.search = "";\n      window.location.reload();\n    }\n  };\n\n  useEffect(() => {\n    fetchAuthUrl();\n  }, [fetchAuthUrl]);\n\n  return (\n    <>\n      {isSuccess ? (\n        <>\n          <button onClick={handleLogout}>\ub85c\uadf8\uc544\uc6c3</button>\n          <button onClick={getFiles}>\ud30c\uc77c \uac00\uc838\uc624\uae30</button>\n        </>\n      ) : (\n        <button onClick={(window.location.href = authUrl)}>\n          \uad6c\uae00 \ub4dc\ub77c\uc774\ube0c \uc5f0\uacb0\ud558\uae30\n        </button>\n      )}\n    </>\n  );\n};\n\nexport default HomePage;\n')),(0,o.kt)("p",null,"API_ENDPOINT_ORIGIN\uc758 \uacbd\uc6b0, \ub85c\uceec\uc5d0\uc11c\ub294 localhost:3000\uc744 \ub530\ub974\uace0, \ubc30\ud3ec \uc2dc\uc5d0\ub294 \ud574\ub2f9 \uc624\ub9ac\uc9c4\uc5d0 \ub9de\uac8c \ud560\ub2f9\ud558\uba74 \ub429\ub2c8\ub2e4."),(0,o.kt)("p",null,"\uc774\uc81c \uc11c\ubc84 \ub85c\uc9c1\uc744 \uc9ed\ub2c8\ub2e4."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-tsx"},'// pages/api/auth.ts\nimport oauth2Client from "@/utils/googleAuth";\nimport { NextApiRequest, NextApiResponse } from "next";\n\nexport default async function handler(\n  req: NextApiRequest,\n  res: NextApiResponse\n) {\n  try {\n    // CORS \ud504\ub9ac\ud50c\ub77c\uc774\ud2b8 \uc694\uccad \ucc98\ub9ac\n    if (req.method === "OPTIONS") {\n      res.status(200).end();\n      return;\n    }\n\n    if (req.method === "GET") {\n      const refreshToken = req.cookies.refresh_token;\n\n      // \uc774\ubbf8 \ub85c\uadf8\uc778\ud588\uc5c8\ub358 \uc774\ub825\uc774 \uc788\ub294\uc9c0 \ud655\uc778\n      if (!refreshToken) {\n        const url = oauth2Client.generateAuthUrl({\n          access_type: "offline",\n          prompt: "consent",\n          scope: ["https://www.googleapis.com/auth/drive"],\n          redirect_uri: process.env.API_ENDPOINT_ORIGIN,\n        });\n        res.status(200).json({ success: false, url });\n      }\n\n      // \ub9ac\ud504\ub808\uc2dc \ud1a0\ud070\uc73c\ub85c \uc561\uc138\uc2a4 \ud1a0\ud070 \uac31\uc2e0\n      oauth2Client.setCredentials({ refresh_token: refreshToken });\n\n      const newTokens = await oauth2Client.refreshAccessToken();\n      oauth2Client.setCredentials(newTokens.credentials);\n\n      res.status(200).json({ success: true });\n    } else if (req.method === "POST") {\n      const { code } = req.body;\n      const { tokens } = await oauth2Client.getToken(code);\n      oauth2Client.setCredentials(tokens);\n\n      // \ub9ac\ud504\ub808\uc2dc \ud1a0\ud070\uc744 HTTP Only \ucfe0\ud0a4\uc5d0 \uc800\uc7a5\n      if (tokens.refresh_token) {\n        res.setHeader(\n          "Set-Cookie",\n          `refresh_token=${tokens.refresh_token}; HttpOnly; Path=/; Max-Age=${\n            7 * 24 * 60 * 60\n          }`\n        );\n      }\n\n      res.status(200).json({ success: true });\n    } else if (req.method === "DELETE") {\n      // \ub85c\uadf8\uc544\uc6c3 \ucc98\ub9ac\n      // \ub9ac\ud504\ub808\uc2dc \ud1a0\ud070 \ucfe0\ud0a4 \uc0ad\uc81c\n      res.setHeader(\n        "Set-Cookie",\n        "refresh_token=; HttpOnly; Path=/; Max-Age=0"\n      );\n      res.status(200).json({ success: true });\n    } else {\n      res.status(405).end(); // Method Not Allowed\n    }\n  } catch (err) {\n    console.log("ERR", err);\n    res.status(500).json({ error: "Internal Server Error" });\n  }\n}\n')))}d.isMDXComponent=!0}}]);